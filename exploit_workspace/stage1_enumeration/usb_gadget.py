#!/usr/bin/env python3
"""
Stage 1: USB Enumeration Module

Handles initial USB device presentation and boot quirk detection.
"""

from dataclasses import dataclass
from typing import Optional, Dict
import struct


@dataclass
class Stage1Config:
    """Configuration for Stage 1"""
    vid: int = 0x041e  # Creative
    pid: int = 0x3000  # Extigy
    wTotalLength: int = 794  # Triggers quirk
    initial_bnum: int = 1


class USBEnumerator:
    """Manages USB enumeration for Stage 1"""

    QUIRK_SIGNATURE = {
        "request": 0x10,
        "request_type": 0x43,
        "value": 0x0001,
        "index": 0x000a
    }

    def __init__(self, config: Stage1Config = None):
        self.config = config or Stage1Config()
        self.quirk_received = False

    def build_device_descriptor(self) -> bytes:
        """Build initial device descriptor"""
        return struct.pack(
            '<BBHBBBBHHHBBBB',
            18, 0x01, 0x0200, 0, 0, 0, 64,
            self.config.vid, self.config.pid,
            0x0100, 1, 2, 3, self.config.initial_bnum
        )

    def is_quirk_message(self, req: int, req_type: int, val: int, idx: int) -> bool:
        """Check if message is the boot quirk trigger"""
        return (
            req == self.QUIRK_SIGNATURE["request"] and
            req_type == self.QUIRK_SIGNATURE["request_type"] and
            val == self.QUIRK_SIGNATURE["value"] and
            idx == self.QUIRK_SIGNATURE["index"]
        )

    def handle_quirk(self) -> bytes:
        """Handle boot quirk - transition to Stage 2"""
        self.quirk_received = True
        return b''  # Acknowledge
