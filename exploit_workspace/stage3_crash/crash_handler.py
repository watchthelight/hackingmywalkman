#!/usr/bin/env python3
"""
Stage 3: Crash Handler Module

Monitors and handles kernel crash/corruption events.
"""

from dataclasses import dataclass
from typing import List, Optional
from enum import Enum


class CrashType(Enum):
    PANIC = "kernel_panic"
    OOPS = "kernel_oops"
    KASAN = "kasan_report"
    GPF = "general_protection_fault"
    NULL_DEREF = "null_pointer_dereference"
    OOB = "slab_out_of_bounds"
    UAF = "use_after_free"
    UNKNOWN = "unknown"


@dataclass
class CrashInfo:
    """Information about a kernel crash"""
    crash_type: CrashType
    message: str
    address: Optional[int] = None
    function: Optional[str] = None
    stack_trace: List[str] = None


class CrashHandler:
    """Handles crash detection and analysis"""

    CRASH_PATTERNS = {
        "Kernel panic": CrashType.PANIC,
        "Oops:": CrashType.OOPS,
        "KASAN:": CrashType.KASAN,
        "general protection fault": CrashType.GPF,
        "NULL pointer dereference": CrashType.NULL_DEREF,
        "slab-out-of-bounds": CrashType.OOB,
        "use-after-free": CrashType.UAF,
    }

    def parse_dmesg(self, dmesg: str) -> Optional[CrashInfo]:
        """Parse dmesg output for crash information"""
        for pattern, crash_type in self.CRASH_PATTERNS.items():
            if pattern in dmesg:
                return CrashInfo(
                    crash_type=crash_type,
                    message=self._extract_crash_message(dmesg, pattern),
                    address=self._extract_address(dmesg),
                    function=self._extract_function(dmesg)
                )
        return None

    def _extract_crash_message(self, dmesg: str, pattern: str) -> str:
        """Extract crash message around pattern"""
        idx = dmesg.find(pattern)
        if idx == -1:
            return ""
        end = dmesg.find('\n', idx)
        return dmesg[idx:end if end != -1 else idx + 200]

    def _extract_address(self, dmesg: str) -> Optional[int]:
        """Extract faulting address from crash"""
        import re
        match = re.search(r'at (?:address )?(?:0x)?([0-9a-fA-F]+)', dmesg)
        if match:
            try:
                return int(match.group(1), 16)
            except:
                pass
        return None

    def _extract_function(self, dmesg: str) -> Optional[str]:
        """Extract faulting function from crash"""
        import re
        match = re.search(r'in (\w+)\+0x', dmesg)
        if match:
            return match.group(1)
        return None
